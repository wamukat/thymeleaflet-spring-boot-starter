<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<!--
/**
 * çµ±ä¸€JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * 
 * Thymeleafletã§å…±é€šä½¿ç”¨ã•ã‚Œã‚‹JavaScripté–¢æ•°ç¾¤ã‚’çµ±ä¸€ç®¡ç†ã™ã‚‹ã€‚
 * ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã€èƒŒæ™¯è‰²åˆ‡æ›¿ã€è‰²åˆ†æãªã©ã®å…±é€šå‡¦ç†ã‚’æä¾›ã€‚
 * 
 * @fragment scripts - å…¨JavaScripté–¢æ•°ã‚’å«ã‚€ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @fragment copyOnly - ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @fragment backgroundOnly - èƒŒæ™¯è‰²åˆ‡æ›¿æ©Ÿèƒ½ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @fragment analysisOnly - è‰²åˆ†ææ©Ÿèƒ½ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * 
 * @example
 * // å…¨æ©Ÿèƒ½ã‚’ä½¿ç”¨
 * <div th:replace="~{thymeleaflet/fragments/common-scripts :: scripts()}"></div>
 * 
 * @example
 * // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®ã¿ä½¿ç”¨
 * <div th:replace="~{thymeleaflet/fragments/common-scripts :: copyOnly()}"></div>
*/
-->

<!-- å…¨JavaScripté–¢æ•° -->
<!--
/**
 * çµ±ä¸€JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆå…¨æ©Ÿèƒ½ï¼‰
 * 
 * @fragment scripts - å…¨JavaScripté–¢æ•°ã‚’å«ã‚€ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @example <div th:replace="~{thymeleaflet/fragments/common-scripts :: scripts()}"></div>
 */
-->
<th:block th:fragment="scripts">
<script th:replace="~{thymeleaflet/fragments/common-scripts :: copyOnly}"></script>
<script th:replace="~{thymeleaflet/fragments/common-scripts :: analysisOnly}"></script>
<script th:replace="~{thymeleaflet/fragments/common-scripts :: htmxUrlSyncOnly}"></script>
<script th:replace="~{thymeleaflet/fragments/common-scripts :: langOnly}"></script>
<script th:replace="~{thymeleaflet/fragments/common-scripts :: initOnly}"></script>
<script th:replace="~{thymeleaflet/fragments/common-scripts :: backgroundFunction}"></script>
</th:block>

<!--
/**
 * ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®ã¿ã®JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * 
 * @fragment copyOnly - ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @example <div th:replace="~{thymeleaflet/fragments/common-scripts :: copyOnly()}"></div>
 */
-->
<script th:fragment="copyOnly">
    function copyUsageExample(elementId = 'usage-example') {
        const element = document.getElementById(elementId);
        if (!element) {
            console.warn(`Element with ID '${elementId}' not found`);
            return;
        }
        
        const codeElement = element.querySelector('code');
        if (!codeElement) {
            console.warn(`Code element not found in '${elementId}'`);
            return;
        }
        
        const text = codeElement.textContent || codeElement.innerText;
        
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback(elementId);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                fallbackCopyTextToClipboard(text, elementId);
            });
        } else {
            fallbackCopyTextToClipboard(text, elementId);
        }
    }
    
    function fallbackCopyTextToClipboard(text, elementId) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopyFeedback(elementId);
            } else {
                console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹å¼ã§ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        } catch (err) {
            console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹å¼ã§ã‚³ãƒ”ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', err);
        }
        
        document.body.removeChild(textArea);
    }
    
    function showCopyFeedback(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const button = element.querySelector('.copy-button');
        if (!button) return;
        
        const originalText = button.innerHTML;
        const copyDoneLabel = document.body?.dataset?.copyDone || 'Copied!';
        button.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>${copyDoneLabel}`;
        button.classList.add('btn-thymeleaflet-success');
        button.classList.remove('btn-thymeleaflet-secondary');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-thymeleaflet-success');
            button.classList.add('btn-thymeleaflet-secondary');
        }, 2000);
    }
</script>

<!--
/**
 * è‰²åˆ†ææ©Ÿèƒ½ã®ã¿ã®JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * 
 * @fragment analysisOnly - è‰²åˆ†ææ©Ÿèƒ½ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @example <div th:replace="~{thymeleaflet/fragments/common-scripts :: analysisOnly()}"></div>
 */
-->
<script th:fragment="analysisOnly">
    function getPreviewAnalysisRoot(container) {
        if (!container) return null;
        const host = container.querySelector('#fragment-preview-host');
        if (host && host.shadowRoot) {
            return host.shadowRoot;
        }
        return container;
    }

    function analyzePreviewColors(containerId = 'preview-container') {
        const container = document.getElementById(containerId);
        if (!container) {
            console.warn(`Container with ID '${containerId}' not found`);
            return { colors: [], dominantColor: null, colorCount: 0 };
        }

        const analysisRoot = getPreviewAnalysisRoot(container);
        if (!analysisRoot) {
            return { colors: [], dominantColor: null, colorCount: 0 };
        }

        const elements = analysisRoot.querySelectorAll('[style*="color"], [class*="text-"], [class*="bg-"]');
        const colorSet = new Set();
        const bgColorSet = new Set();
        
        elements.forEach(element => {
            const style = element.style;
            if (style.color) {
                colorSet.add(style.color);
            }
            if (style.backgroundColor) {
                bgColorSet.add(style.backgroundColor);
            }
            
            const classes = element.className.split(' ');
            classes.forEach(cls => {
                if (cls.startsWith('text-') && !cls.includes('size') && !cls.includes('align')) {
                    colorSet.add(cls);
                }
                if (cls.startsWith('bg-') && !cls.includes('opacity')) {
                    bgColorSet.add(cls);
                }
            });
        });
        
        const allColors = [...colorSet, ...bgColorSet];
        const colorCount = allColors.length;
        const dominantColor = allColors.length > 0 ? allColors[0] : null;
        
        const result = {
            colors: allColors,
            textColors: Array.from(colorSet),
            backgroundColors: Array.from(bgColorSet),
            dominantColor: dominantColor,
            colorCount: colorCount,
            hasColorVariety: colorCount > 3
        };
        
        console.log('Color analysis result:', result);
        return result;
    }

    /**
     * è‰²æ–‡å­—åˆ—ã‹ã‚‰è¼åº¦ã‚’è¨ˆç®—ã—ã€æ˜ã‚‹ã„è‰²ã‹ã©ã†ã‹ã‚’åˆ¤å®š
     * currentColorã®å ´åˆã¯å®Ÿéš›ã®è‰²ã‚’è§£æ±ºã™ã‚‹
     * 
     * @param {string} colorStr - è‰²æ–‡å­—åˆ— (ä¾‹: "rgb(255, 255, 255)")
     * @param {Element} element - è‰²ã®å‚ç…§å…ƒè¦ç´ ï¼ˆcurrentColorè§£æ±ºç”¨ï¼‰
     * @returns {boolean} æ˜ã‚‹ã„è‰²ã®å ´åˆtrue
     */
    function isLightColor(colorStr, element = null) {
        if (!colorStr || colorStr === 'none' || colorStr.startsWith('url')) return false;
        
        // currentColorã®å ´åˆã¯å®Ÿéš›ã®è‰²ã‚’è§£æ±º
        if (colorStr === 'currentColor' && element) {
            const computedStyle = window.getComputedStyle(element);
            const actualColor = computedStyle.color;
            console.log(`ğŸ”„ Resolving currentColor: ${colorStr} -> ${actualColor}`);
            
            if (actualColor && actualColor !== 'currentColor') {
                return isLightColor(actualColor, null);
            }
        }
        
        // inheritã®å ´åˆã¯è¦ªè¦ç´ ã‹ã‚‰è‰²ã‚’å–å¾—
        if (colorStr === 'inherit' && element && element.parentElement) {
            const parentStyle = window.getComputedStyle(element.parentElement);
            const parentColor = parentStyle.color;
            console.log(`ğŸ”„ Resolving inherit: ${colorStr} -> ${parentColor}`);
            
            if (parentColor && parentColor !== 'inherit') {
                return isLightColor(parentColor, element.parentElement);
            }
        }
        
        // currentColor/inheritã§è§£æ±ºã§ããªã„å ´åˆã¯false
        if (colorStr === 'currentColor' || colorStr === 'inherit') {
            console.log(`âš ï¸ Could not resolve ${colorStr}`);
            return false;
        }
        
        try {
            const rgbMatch = colorStr.match(/\d+/g);
            if (!rgbMatch || rgbMatch.length < 3) return false;
            
            const [r, g, b] = rgbMatch.map(Number);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b);
            const isLight = luminance > 200;
            
            console.log(`ğŸ¨ Color analysis: ${colorStr} -> RGB(${r},${g},${b}) -> Luminance: ${luminance.toFixed(1)} -> ${isLight ? 'LIGHT' : 'DARK'}`);
            
            return isLight;
        } catch (e) {
            console.error('Could not parse color:', colorStr, e);
            return false;
        }
    }
</script>

<!--
/**
 * HTMX URLåŒæœŸã®ã¿ã®JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * 
 * @fragment htmxUrlSyncOnly - HTMX URLåŒæœŸã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @example <div th:replace="~{thymeleaflet/fragments/common-scripts :: htmxUrlSyncOnly()}"></div>
 */
-->
<script th:fragment="htmxUrlSyncOnly">
    /**
     * HTMXã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆURLã‚’ãƒ–ãƒ©ã‚¦ã‚¶URLã«åæ˜ 
     * hx-push-urlãŒ/defaultå›ºå®šã§ã‚‚ã€å®Ÿéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹URLã¸åŒæœŸã™ã‚‹
     */
    document.addEventListener('htmx:afterRequest', function(event) {
        const xhr = event?.detail?.xhr;
        if (!xhr || !xhr.responseURL) return;
        if (!xhr.responseURL.includes('/thymeleaflet/')) return;

        let responseUrl;
        try {
            responseUrl = new URL(xhr.responseURL, window.location.origin);
        } catch (error) {
            return;
        }

        const path = responseUrl.pathname;
        if (path.endsWith('/usage') || path.endsWith('/render') || path.endsWith('/main-content')) {
            return;
        }

        let nextPath = path;
        if (path.endsWith('/content')) {
            nextPath = path.slice(0, -'/content'.length);
        }

        const nextUrl = nextPath + responseUrl.search + responseUrl.hash;
        if (window.location.pathname + window.location.search + window.location.hash === nextUrl) {
            return;
        }
        window.history.replaceState(null, '', nextUrl);
    });
</script>

<!--
/**
 * è¨€èªåˆ‡æ›¿ã®ã¿ã®JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * 
 * @fragment langOnly - è¨€èªåˆ‡æ›¿ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @example <div th:replace="~{thymeleaflet/fragments/common-scripts :: langOnly()}"></div>
 */
-->
<script th:fragment="langOnly">
    /**
     * è¨€èªã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆCookieã«ä¿å­˜ï¼‰
     *
     * @param {string} lang - è¨€èªã‚³ãƒ¼ãƒ‰ (ä¾‹: "en", "ja")
     */
    function setThymeleafletLang(lang) {
        if (!lang) return;
        const url = new URL(window.location.href);
        url.searchParams.set('lang', lang);
        window.location.href = url.toString();
    }
</script>

<!--
/**
 * åˆæœŸåŒ–ã®ã¿ã®JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * 
 * @fragment initOnly - åˆæœŸåŒ–ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @example <div th:replace="~{thymeleaflet/fragments/common-scripts :: initOnly()}"></div>
 */
-->
<script th:fragment="initOnly">
    /**
     * åˆæœŸåŒ–å‡¦ç†
     * DOMContentLoadedæ™‚ã«å¿…è¦ãªåˆæœŸè¨­å®šã‚’å®Ÿè¡Œ
     */
    function initializeCommonScripts() {
        console.log('ğŸš€ THYMELEAFLET: initializeCommonScripts started');
        
        const previewContainer = document.getElementById('preview-container');
        if (previewContainer && !previewContainer.classList.contains('preview-background-light') && !previewContainer.classList.contains('preview-background-gray')) {
            previewContainer.classList.remove('preview-background-white');
            previewContainer.classList.add('preview-background-light');
        }
        
        console.log('âœ… THYMELEAFLET: Common scripts initialized with fixed light preview background');
    }
    
    // DOMContentLoadedæ™‚ã®åˆæœŸåŒ–
    console.log('ğŸ”„ THYMELEAFLET: Script execution started, document ready state:', document.readyState);
    
    if (document.readyState === 'loading') {
        console.log('ğŸ“„ THYMELEAFLET: Document still loading, adding DOMContentLoaded listener');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ THYMELEAFLET: DOMContentLoaded event fired');
            initializeCommonScripts();
        });
    } else {
        console.log('ğŸ“„ THYMELEAFLET: Document already loaded, initializing immediately');
        initializeCommonScripts();
    }
</script>

<!--
/**
 * èƒŒæ™¯è‰²åˆ‡æ›¿æ©Ÿèƒ½ã®JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * 
 * @fragment backgroundFunction - èƒŒæ™¯è‰²åˆ‡æ›¿æ©Ÿèƒ½ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @example <div th:replace="~{thymeleaflet/fragments/common-scripts :: backgroundFunction()}"></div>
 */
-->
<script th:fragment="backgroundFunction">
    function togglePreviewBackground(containerId = 'preview-container') {
        const container = document.getElementById(containerId);
        const button = document.getElementById('background-toggle');
        
        if (!container) {
            console.warn(`Container with ID '${containerId}' not found`);
            return;
        }
        
        const isDark = container.classList.contains('preview-background-gray');
        const lightLabel = button?.dataset?.labelLight || 'Light';
        const darkLabel = button?.dataset?.labelDark || 'Dark';
        
        if (isDark) {
            container.classList.remove('preview-background-gray');
            container.classList.add('preview-background-light');
            if (button) {
                button.innerHTML = `<span id="toggle-icon">â˜€ï¸</span> <span id="toggle-text">${lightLabel}</span>`;
            }
        } else {
            container.classList.remove('preview-background-light', 'preview-background-white');
            container.classList.add('preview-background-gray');
            if (button) {
                button.innerHTML = `<span id="toggle-icon">ğŸŒ™</span> <span id="toggle-text">${darkLabel}</span>`;
            }
        }

        if (typeof window.__thymeleafletRefreshPreview === 'function') {
            window.__thymeleafletRefreshPreview();
        }
    }
</script>
<!--
/**
 * èƒŒæ™¯è‰²åˆ‡æ›¿æ©Ÿèƒ½ã®ã¿ã®JavaScriptãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
 * 
 * @fragment backgroundOnly - èƒŒæ™¯è‰²åˆ‡æ›¿æ©Ÿèƒ½ã®ã¿ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ
 * @example <div th:replace="~{thymeleaflet/fragments/common-scripts :: backgroundOnly()}"></div>
 */
-->
<script th:fragment="backgroundOnly" th:replace="~{thymeleaflet/fragments/common-scripts :: backgroundFunction}"></script>

</body>
</html>
